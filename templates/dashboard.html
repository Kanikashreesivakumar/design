<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
    --primary-color: #2c3e50;
    --secondary-color: #0099ff;
    --accent-color: #e9311d;
    --success-color: #27ae60;
    --light-gray: #ecf0f1;
    --medium-gray: #2f8cca;
    --dark-gray: #7f8c8d;
    --white: #ffffff;
    --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --border-radius: 18px;
    --card-radius: 22px;
    --transition: all 0.2s cubic-bezier(.4,0,.2,1);
}

body, html {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    height: auto;
    overflow-x: hidden;
    overflow-y: auto;
    background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 40%, #a1c4fd 100%);
    color: #333;
    line-height: 1.6;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:
        url("{{ url_for('static', filename='b.jpg') }}") center center fixed;
    background-size: 1400px auto; 
    margin: 0;
    padding: 0;
    min-height: 100vh;
    color: #333;
    line-height: 1.6;
}

.dashboard-scale-wrapper {
    width: 100vw;
    min-height: 100vh;
    height: auto;
    overflow: visible;
    position: relative;
    background: inherit;
}

.dashboard-container {
    background: rgba(255,255,255,0);
    border-radius: 0;
    box-shadow: 0 8px 40px 0 rgba(31, 38, 135, 0.10);
    border: none;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    width: 100vw;
    height: 100vh;
    margin: 0;
    padding: 0;
}

.dashboard-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--medium-gray);
    background: linear-gradient(90deg, #e0eafc 0%, #cfdef3 100%);
    border-radius: 24px 24px 0 0;
    box-shadow: 0 2px 12px 0 rgba(44, 62, 80, 0.07);
}

.dashboard-header h1 {
    color: var(--primary-color);
    font-size: 32px;
    margin-bottom: 10px;
    letter-spacing: 1px;
    font-weight: 700;
}

.dashboard-header p {
    color: var(--dark-gray);
    font-size: 17px;
    margin-bottom: 0;
}

.filter-section {
    background: linear-gradient(120deg, #fafdff 0%, #e0eafc 100%);
    padding: 24px 20px 18px 20px;
    border-radius: 24px;
    box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.10);
    margin-bottom: 32px;
    text-align: center;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    gap: 24px;
    border: 2px solid #e0eafc;
}

.filter-title {
    font-size: 20px;
    color: var(--primary-color);
    margin-bottom: 18px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

#trolley-buttons {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
}

.trolley-button {
    margin: 5px 8px;
    padding: 10px 26px;
    font-size: 15px;
    font-weight: 500;
    border: none;
    border-radius: 22px;
    background: linear-gradient(90deg, #e0eafc 0%, #cfdef3 100%);
    color: var(--primary-color);
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.06);
    outline: none;
    position: relative;
    z-index: 1;
}

.trolley-button:hover, .trolley-button.active {
    background: linear-gradient(90deg, #0099ff 0%, #2f8cca 100%);
    color: var(--white);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.18);
    transform: translateY(-2px) scale(1.04);
}

.card-container {
    display: flex;
    gap: 24px;
    margin-top: 10px;
}

.card {
    min-width: 140px;
    flex: 1;
    border-radius: 22px;
    box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.10);
    text-align: center;
    padding: 12px 4px;
    font-size: 14px;
    font-weight: 500;
    transition: var(--transition);
    border: 2.5px solid transparent;
    background: linear-gradient(120deg, #fafdff 0%, #e0eafc 100%);
    position: relative;
    overflow: hidden;
}
.card:nth-child(1) {
    border-image: linear-gradient(120deg, #f8d7da 60%, #e9311d 100%) 1;
}
.card:nth-child(2) {
    border-image: linear-gradient(120deg, #d1ecf1 60%, #17a2b8 100%) 1;
}
.card:nth-child(3) {
    border-image: linear-gradient(120deg, #d4edda 60%, #27ae60 100%) 1;
}

.card h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: var(--primary-color);
    font-weight: 600;
}

.card p {
    font-size: 22px;
    font-weight: bold;
    margin: 0;
    color: var(--accent-color);
}

.card:nth-child(2) p { color: #17a2b8; }
.card:nth-child(3) p { color: #27ae60; }

.dashboard-content {
    overflow-x: auto;
    white-space: nowrap;
    display: flex;
    flex-direction: row;
    gap: 30px;
}

.chart-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 28px;
    min-width: 1000px;
    margin-bottom: 40px;
}

.chart-container {
    min-height: 340px;
    height: 340px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    padding: 32px 24px 24px 24px;
    margin-bottom: 40px;
    background: linear-gradient(120deg, #fafdff 0%, #e0eafc 100%);
    border-radius: 22px;
    box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.10);
    padding: 24px 18px 18px 18px;
    margin-bottom: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 2.5px solid transparent;
    position: relative;
    overflow: hidden;
}
.chart-container:nth-child(1) {
    border-image: linear-gradient(120deg, #e0eafc 60%, #0099ff 100%) 1;
}
.chart-container:nth-child(2) {
    border-image: linear-gradient(120deg, #f8d7da 60%, #e9311d 100%) 1;
}
.chart-container.concern-gap {
    border-image: linear-gradient(120deg, #d1ecf1 60%, #17a2b8 100%) 1;
}
.chart-container:nth-child(4) {
    border-image: linear-gradient(120deg, #d4edda 60%, #27ae60 100%) 1;
}

.concern-gap {
    margin-bottom: 40px;
    padding-right: 90px;
}

.chart-title {
    margin-bottom: 18px;
    font-size: 20px;
    color: var(--primary-color);
    margin-bottom: 18px;
    font-weight: 700;
    text-align: center;
    letter-spacing: 0.5px;
}

canvas {
    width: 100% !important;
    height: 220px !important;
    max-height: 220px;
    min-height: 180px;
    background: #f8fafd;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.04);
    transition: box-shadow 0.2s;
}

canvas:hover {
    box-shadow: 0 6px 24px rgba(44, 62, 80, 0.13);
}

.table-section {
    flex: 1;
    margin-top: 20px;
    padding: 32px 60px;
    width: 100%;
    background: linear-gradient(120deg, #fafdff 0%, #e0eafc 100%);
    border-radius: 22px;
    box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.10);
    padding: 16px 8px;

    border: 2.5px solid;
    border-image: linear-gradient(120deg, #e0eafc 60%, #0099ff 100%) 1;
    animation: fadeIn 1.3s;
}

.section-title {
    font-size: 22px;
    color: var(--primary-color);
    margin-bottom: 20px;
    font-weight: 700;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--light-gray);
    background: linear-gradient(90deg, #e0eafc 0%, #cfdef3 100%);
    border-radius: 12px 12px 0 0;
}

.trolley-section {
    display: none;
}

.trolley-section.active {
    display: block;
}

.trolley-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 13px;
    background: #fafdff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 12px 0 rgba(44, 62, 80, 0.07);
}

.trolley-table th {
    background: linear-gradient(90deg, #0099ff 0%, #2f8cca 100%);
    color: var(--white);
    padding: 14px 16px;
    text-align: left;
    position: sticky;
    top: 0;
    font-size: 15px;
    letter-spacing: 0.5px;
    border-right: 2px solid #e0eafc;
}

.trolley-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--light-gray);
    border-right: 2px solid #e0eafc;
}

.trolley-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.trolley-table tr:hover {
    background-color: #e9ecef;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 7px;
}

.status-overdue {
    background-color: var(--accent-color);
}

.status-due {
    background-color: #f39c12;
}

.status-ok {
    background-color: var(--success-color);
}

.blue-underline {
    width: 100vw;
    height: 2px; /* Very thin */
    margin: 12px 0 0 0;
    background: linear-gradient(90deg, #0099ff 0%, #2f8cca 100%);
    border-radius: 0;
    position: relative;
    left: 50%;
    right: 50%;
    transform: translateX(-50%);
}

@media (max-width: 1200px) {
    .dashboard-content {
        flex-direction: column;
    }
    .chart-section, .table-section {
        flex: 1;
    }
    .chart-section {
        min-width: 0;
        grid-template-columns: 1fr;
    }
}

@media (max-width: 900px), (max-height: 700px) {
    .dashboard-header h1 { font-size: 18px; }
    .dashboard-header p { font-size: 12px; }
    .trolley-button { font-size: 11px; padding: 6px 10px; }
    .card h4, .card p { font-size: 13px; }
    .chart-container { min-height: 220px; height: 220px; }
    canvas { height: 120px !important; max-height: 120px; }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 10px;
    }
    .chart-container, .table-section {
        padding: 12px;
    }
    .card-container {
        flex-direction: column;
        gap: 12px;
    }
    .chart-section {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .chart-section {
        min-width: 0;
    }
    .chart-container {
        min-height: 120px;
        height: 120px;
        padding: 8px;
    }
    canvas {
        height: 80px !important;
        max-height: 80px;
    }
}
    </style>
</head>
<body>



<div class="dashboard-scale-wrapper">
    <div class="dashboard-container">
        
        <header class="dashboard-header">
            <h1>Trolley Maintenance Dashboard</h1>
            <p>Comprehensive overview of trolley maintenance status and schedules</p>
        </header>

        <div class="filter-section">
            <div class="filter-title">Select Trolley Type</div>
            <div id="trolley-buttons">
                {% for trolley in trolley_types %}
                <button class="trolley-button" onclick="showTrolleyData('{{ trolley }}')">{{ trolley }}</button>
                {% endfor %}
            </div>
            <div class="card-container" style="display: flex; gap: 20px; margin-top: 20px;">
                <div class="card" style="background-color: #f8d7da; padding: 20px; border-radius: 10px;">
                    <h4>Repair</h4>
                    <p id="repairCount">{{ repair_count }}</p>
                </div>
                <div class="card" style="background-color: #d1ecf1; padding: 20px; border-radius: 10px;">
                    <h4>Primary Check</h4>
                    <p id="primaryCheckCount">{{ primary_check_count }}</p>
                </div>
                <div class="card" style="background-color: #d4edda; padding: 20px; border-radius: 10px;">
                    <h4>Complete Check</h4>
                    <p id="completeCheckCount">{{ complete_check_count }}</p>
                </div>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="chart-section">
                <div class="chart-container">
                    <h3 class="chart-title">Trolley Maintenance Status</h3>
                    <canvas id="trolleyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Maintenance Duration Analysis</h3>
                    <canvas id="durationChart"></canvas>
                </div>
                <div class="chart-container concern-gap">
                    <h3 class="chart-title">Common Concerns</h3>
                    <canvas id="concernChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Repair Types</h3>
                    <canvas id="repairChart"></canvas>
                </div>
            </div>

            <div class="table-section">
                <h2 class="section-title">Current Plan</h2>
                {% for trolley_type, records in current_month_plan_by_type.items() %}
                <div id="table-{{ trolley_type }}" class="trolley-section">
                    <h3 class="chart-title">{{ trolley_type }} Maintenance Schedule</h3>
                    <table class="trolley-table">
                        <thead>
                            <tr>
                                <th>Trolley Name</th>
                                <th>Last Maintenance</th>
                                <th>TPM Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in records %}
                            <tr>
                                <td>{{ row['trolley_name'] }}</td>
                                <td>{{ row['previous_completed_date'] }}</td>
                                <td>{{ row['tpm_category'] }}</td>
                                <td>
                                    {% if row['days_left'] < 0 %}
                                    <span class="status-indicator status-overdue"></span> Overdue
                                    {% elif row['days_left'] < 7 %}
                                    <span class="status-indicator status-due"></span> Due soon ({{ row['days_left'] }} days)
                                    {% else %}
                                    <span class="status-indicator status-ok"></span> On track ({{ row['days_left'] }} days)
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    let repairChart;
    const repairData = {{ repair_chart | tojson | safe }};
    const trolleyCharts = {{ trolley_charts | tojson }};
    const trolleyTables = {{ current_month_plan_by_type | tojson }};
    const durationCharts = {{ duration_chart | tojson }};
    const concernChartData = {{ concern_chart | tojson }};
    let chartInstance = null;
    let currentTable = null;
    let durationChartInstance = null;
    let concernChartInstance = null;

    function showTrolleyData(trolleyType) {
        updateChart(trolleyType);
        updateTable(trolleyType);
        updateDurationChart(trolleyType);
        updateActiveButton(trolleyType);
        updateRepairChart(trolleyType);
        updateConcernChart(trolleyType);
        updateTPMCounts(trolleyType);
    }

    function updateRepairChart(trolleyType) {
        const ctx = document.getElementById('repairChart').getContext('2d');
        const labels = repairData[trolleyType]?.labels || [];
        const counts = repairData[trolleyType]?.counts || [];
        if (repairChart) repairChart.destroy();
        repairChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Repair Count',
                    data: counts,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: labels.length > 0
                            ? `Repair Count by Trolley Name (${trolleyType})`
                            : `No Repair Data for ${trolleyType}`
                    }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function updateChart(trolleyType) {
        const data = trolleyCharts[trolleyType];
        const ctx = document.getElementById('trolleyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // Plan bar: green if met, red if not (per bar)
        const planBarColors = data.plan.map((plan, idx) => {
            const actual = data.actual[idx];
            return plan <= actual ? '#27ae60' : '#e9311d'; // Green if met, red if not
        });

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Plan',
                        data: data.plan,
                        backgroundColor: planBarColors
                    },
                    {
                        label: 'Actual',
                        data: data.actual,
                        backgroundColor: '#1976d2' // Blue for Actual
                    }
                ]
            },
            options: {
                responsive: true,
                layout: {
                    padding: {
                        bottom: 20
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#222',
                        font: { weight: 'bold' },
                        formatter: function(value, context) {
                            return value;
                        },
                        clamp: true,
                        offset: 4
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function updateTable(trolleyType) {
        if (currentTable) currentTable.style.display = 'none';
        const tableDiv = document.getElementById(`table-${trolleyType}`);
        if (tableDiv) {
            tableDiv.style.display = 'block';
            currentTable = tableDiv;
        }
    }

    function updateActiveButton(trolleyType) {
        document.querySelectorAll('#trolley-buttons .trolley-button').forEach(btn => {
            btn.classList.remove('active');
        });
        const buttons = document.querySelectorAll('#trolley-buttons .trolley-button');
        buttons.forEach(btn => {
            if (btn.textContent === trolleyType) {
                btn.classList.add('active');
            }
        });
    }

    function updateDurationChart(trolleyType) {
        const data = durationCharts[trolleyType];
        const ctx = document.getElementById('durationChart').getContext('2d');
        if (durationChartInstance) durationChartInstance.destroy();
        durationChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Max Duration (Minutes)',
                    data: data.durations,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Duration (minutes)' }
                    }
                }
            }
        });
    }

    function updateConcernChart(trolleyType) {
        const ctx = document.getElementById('concernChart').getContext('2d');
        if (concernChartInstance) concernChartInstance.destroy();

        let data = concernChartData[trolleyType];

        if (!data || Object.keys(data).length === 0) {
            concernChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        label: 'Concern Count',
                        data: [0],
                        backgroundColor: ['rgba(200, 200, 200, 0.2)']
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#222',
                            font: { weight: 'bold' },
                            formatter: function(value, context) {
                                return value;
                            },
                            clamp: true,
                            offset: 8
                        },
                        title: {
                            display: true,
                            text: `No Concerns Found for ${trolleyType}`
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { display: false }
                    }
                },
                plugins: [ChartDataLabels]
            });
            return;
        }

        const labels = Object.keys(data);
        const values = Object.values(data);


        const barColors = labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 55%)`);

        concernChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Concern Count',
                    data: values,
                    backgroundColor: barColors
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        color: '#222',
                        font: { weight: 'bold' },
                        formatter: function(value, context) {
                            return value;
                        },
                        clamp: true,
                        offset: 8
                    },
                    title: {
                        display: true,
                        text: `Repair Concerns for ${trolleyType}`
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: Math.max(...values) + Math.ceil(Math.max(...values) * 0.2)
                    },
                    y: { stacked: true }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function updateTPMCounts(trolleyType) {
        fetch('/get_tpm_counts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trolleyType: trolleyType })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("repairCount").innerText = data.repair || 0;
            document.getElementById("primaryCheckCount").innerText = data.primary_check || 0;
            document.getElementById("completeCheckCount").innerText = data.complete_check || 0;
        })
        .catch(error => {
            document.getElementById("repairCount").innerText = {{ repair_count }};
            document.getElementById("primaryCheckCount").innerText = {{ primary_check_count }};
            document.getElementById("completeCheckCount").innerText = {{ complete_check_count }};
        });
    }

    window.onload = () => {
        const firstTrolley = Object.keys(trolleyCharts)[0];
        if (firstTrolley) {
            showTrolleyData(firstTrolley);
        }
    };

    function scaleDashboardToFit() {
        const wrapper = document.querySelector('.dashboard-scale-wrapper');
        const container = document.querySelector('.dashboard-container');
        if (!wrapper || !container) return;

        
        container.style.transform = '';
        container.style.transformOrigin = 'top center';

    
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        
        const rect = container.getBoundingClientRect();
        const scaleX = vw / rect.width;
        const scaleY = vh / rect.height;
        
        const scale = Math.min(scaleX, scaleY, 1);

        container.style.transform = `scale(${scale})`;
        container.style.transformOrigin = 'top center';
    }
    window.addEventListener('resize', scaleDashboardToFit);
    window.addEventListener('DOMContentLoaded', scaleDashboardToFit);
</script>
</body>
</html>