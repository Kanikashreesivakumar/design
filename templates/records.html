<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="refresh" content="30">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <title>KitKart RFID Records</title>
    <style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:
        url("{{ url_for('static', filename='b.jpg') }}") center center fixed no-repeat;
    background-size: cover, 1400px auto; /* Adjust 1400px as needed for your image size */
    margin: 0;
    padding: 0;
    color: #2c3e50;
    min-height: 100vh;
}

h1 {
    color: #2c3e50;
    text-align: center;
    margin: 10px 0 0 0;
    font-size: 2.1rem;
    font-weight: 700;
    letter-spacing: 1px;
}

.container {
    max-width: 98vw;
    margin: 24px auto 0 auto;
    background: rgba(255,255,255,0.97);
    padding: 32px 32px 24px 32px;
    border-radius: 24px;
    box-shadow: 0 8px 40px 0 rgba(31, 38, 135, 0.13);
    border: 2px solid #e0eafc;
}

.top_heading {
    color: #52b2f1;
    font-size: 2.2rem;   /* Increased from 1.4rem */
    font-weight: 700;
    margin-bottom: 0.5rem;
    letter-spacing: 1px;
}

.flash-messages {
    background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
    color: #fff;
    padding: 14px 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.13);
}

.container-fluid {
    max-width: 98vw;
    margin: 0 auto 18px auto;
    padding: 0 1vw;
}

.d-flex {
    gap: 1rem;
}

.btn, .btn-outline-secondary, .btn-outline-primary, .btn-outline-success, .btn-outline-danger {
    border-radius: 8px !important;
    font-weight: 500;
    font-size: 1rem;
    padding: 8px 18px;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
}

.btn-outline-secondary:hover,
.btn-outline-primary:hover,
.btn-outline-success:hover,
.btn-outline-danger:hover {
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.13);
    transform: translateY(-2px) scale(1.03);
}

.position-relative .badge {
    font-size: 0.85em;
    padding: 4px 8px;
}

.table-container {
    max-height: 80vh; /*  This creates the scrollable area */
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 16px;
    border: 1.5px solid #e0eafc;
    box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.07);
    margin-top: 24px;
    background: #fff;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 0; /* Remove top margin since container has it */
    background: #fff;
    border-radius: 0; /*  Container has border radius */
    overflow: visible; /*  Allow sticky to work */
    border: none; /* Container has border */
    box-shadow: none; /*  Container has shadow */
    position: relative;
}

thead {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #fff; /*Solid background */
}

thead th {
    position: sticky;
    top: 0;
    z-index: 101;
    background: linear-gradient(90deg, #5eaadd 0%, #4b98cc 100%); /*  Keep gradient */
    box-shadow: 0 2px 8px rgba(0,0,0,0.15); /*  Shadow to show it's floating */
}

tbody {
    position: relative;
    z-index: 1;
}

th, td {
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid #e0eafc;
    font-size: 1rem;
    vertical-align: top;
    color: #2c3e50;
}

th {
    background: linear-gradient(90deg, #5eaadd 0%, #4b98cc 100%);
    color: #fff;
    font-weight: 600;
    font-size: 1.05rem;
    border-right: 1px solid #e0eafc;
}

tr:last-child td {
    border-bottom: none;
}

tr:nth-child(even) {
    background-color: #f8fafd;
}

tr:hover {
    background-color: #e0eafc33;
    transition: background 0.2s;
}

input[type="text"], input[type="date"], select {
    width: 90%;
    padding: 8px;
    border: 1.5px solid #b2bec3;
    border-radius: 6px;
    font-size: 1rem;
    background-color: #fafdff;
    color: #2c3e50;
    transition: border 0.2s;
}

input[type="text"]:focus, input[type="date"]:focus, select:focus {
    border: 1.5px solid #64b2e6;
    background: #f0f8ff;
}

button, .toggle-btn {
    background: linear-gradient(90deg, #5fec9a 0%, #63ce8f 100%);
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background 0.2s, transform 0.2s;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
}

button:hover, .toggle-btn:hover {
    background: linear-gradient(90deg, #58f198 0%, #4dad75 100%);
    transform: translateY(-2px) scale(1.03);
}

.toggle-btn {
    background: linear-gradient(90deg, #3aacf8 0%, #4faceb 100%);
    padding: 6px 14px;
    font-size: 0.95em;
    margin-top: 4px;
}

.toggle-btn:hover {
    background: linear-gradient(90deg, #2f8cca 0%, #58b3f0 100%);
}

.nest-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 5px;
    font-size: 0.97em;
    background: #fafdff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px 0 rgba(44, 62, 80, 0.07);
}

.nest-table th, .nest-table td {
    border: 1px solid #e0eafc;
    padding: 6px 10px;
    text-align: left;
    font-size: 0.97em;
    color: #2c3e50;
}

.nest-table th {
    background: #e0eafc;
    color: #2c3e50;
    font-weight: 600;
}

@media (max-width: 1200px) {
    .container, .container-fluid {
        max-width: 100vw;
        padding: 8px;
    }
    table, .nest-table {
        font-size: 0.95em;
    }
    th, td {
        padding: 8px 6px;
    }
}

@media (max-width: 900px) {
    .container, .container-fluid {
        padding: 2vw;
    }
    table, .nest-table {
        font-size: 0.92em;
    }
    th, td {
        padding: 6px 4px;
    }
}

@media (max-width: 768px) {
    .container, .container-fluid {
        padding: 0;
    }
    table, .nest-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
    th, td {
        padding: 10px 6px;
        font-size: 0.95em;
    }
    .btn, button, .toggle-btn {
        font-size: 0.95em;
        padding: 7px 10px;
    }
}

@media (max-width: 480px) {
    .container, .container-fluid {
        padding: 0;
    }
    h1, .top_heading {
        font-size: 1.1rem;
    }
    th, td {
        font-size: 0.85em;
        padding: 5px 2px;
    }
}

.header-block {
    text-align: center;
    margin-bottom: 18px;
}

.blue-underline {
    width: 220px;
    max-width: 90vw;
    height: 5px;
    margin: 18px auto 0 auto;
    background: linear-gradient(90deg, #0099ff 0%, #2f8cca 100%);
    border-radius: 3px;
}

.btn-repair-log {
    background-color: #dc3545 !important;   
    color: #fff !important;
    border: 1.5px solid #dc3545 !important;
    transition: background 0.2s, color 0.2s, border 0.2s;
}
.btn-repair-log:hover, .btn-repair-log:focus {
    background-color: #61040d !important;  
    color: #fff !important;
    border: 1.5px solid #a71d2a !important;
}

/* Add this CSS for notification badge styling */
.notification-badge {
    position: relative;
    display: inline-block;
}

.notification-badge .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4444;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
    line-height: 1.2;
}

.notification-badge .badge.zero {
    display: none;
}

.repair-log-button {
    position: relative;
    margin: 10px;
    padding: 10px 20px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    display: inline-block;
}

.repair-log-button:hover {
    background-color: #0056b3;
    color: white;
    text-decoration: none;
}
  </style>
  <script>
function toggleRows(button) {
  const nestedTable = button.closest('table');
  const extraRows = nestedTable.querySelectorAll('.extra-row');
  const isHidden = extraRows[0].style.display === 'none';

  extraRows.forEach(row => {
    row.style.display = isHidden ? 'table-row' : 'none';
  });

  button.textContent = isHidden ? 'Show Less' : 'Show More';
}
    function downloadFilteredExcel() {
  const form = document.getElementById('filterForm');
  const trolleyPrefix = form.querySelector('[name="trolley_prefix"]').value;
  let url = '/download_excel';

  if (trolleyPrefix) {
    url += `?trolley_prefix=${encodeURIComponent(trolleyPrefix)}`;
  }

  window.location.href = url;
}

function updateRepairLogCount() {
    fetch('/api/repair-log-count')
        .then(response => response.json())
        .then data => {
            const badge = document.getElementById('repair-count-badge');
            if (badge) {
                badge.textContent = data.pending_count;
                // Hide badge if count is 0
                if (data.pending_count === 0) {
                    badge.classList.add('zero');
                } else {
                    badge.classList.remove('zero');
                }
            }
        })
        .catch(error => console.error('Error updating repair count:', error));
}

// Update count every 30 seconds
setInterval(updateRepairLogCount, 30000);

// Update count when page loads
document.addEventListener('DOMContentLoaded', updateRepairLogCount);

// Update count when user returns to page
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        updateRepairLogCount();
    }
});
</script>

</head>
<body>

<div style="
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-top: 16px; /* Reduced top margin */
    margin-bottom: 18px;
    background: rgba(255,255,255,0.92);
    border-radius: 22px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.13);
    padding: 16px 24px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
">
  <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:200px;object-fit:contain; margin-right: 16px;">
  <div style="text-align: left;">
    <h1 class="top_heading" style="margin-bottom: 0.3em;">RENAULT NISSAN <br/> AUTOMOTIVE INDIA PRIVATE LIMITED</h1>
    <h1 style="font-size:1.5rem; margin-top: 0;">KITKART TPM MONITORING SYSTEM</h1>
    <div class="blue-underline"></div>
  </div>
</div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-messages">
      <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endwith %}

<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">


    <div class="d-flex align-items-center gap-2 flex-wrap">

      <form action="/dashboard" method="get" class="d-inline">
        <button type="submit" class="btn btn-outline-dark">
          <i class="bi bi-speedometer2 me-1"></i> Dashboard
        </button>
      </form>

      
<form method="get" action="/records" class="d-flex align-items-center gap-2" id="filterForm">
  <select name="trolley_prefix" class="form-select">
    <option value="">All</option>
    {% for name in trolley_names %}
      <option value="{{ name }}" {% if trolley_prefix == name %}selected{% endif %}>{{ name }}</option>
    {% endfor %}
  </select>

  <button type="submit" class="btn btn-outline-primary">
    <i class="bi bi-funnel me-1"></i> Filter
  </button>


</form>
    </div>

    <div class="d-flex align-items-center gap-2 flex-wrap">

      <form action="/download_excel" method="get" class="d-inline">
     <button type="button" class="btn btn-outline-success" onclick="downloadFilteredExcel()">
    <i class="bi bi-download me-1"></i> Download
  </button>
      </form>
      
<div class="notification-badge">
    <a href="/repair-log" class="repair-log-button">
        ðŸ”§ Repair Log
    </a>
    <span class="badge" id="repair-count-badge">{{ pending_count }}</span>
</div>

    </div>

  </div>
</div>
<!--  ADD SCROLLABLE CONTAINER -->
<div class="table-container">
<table>
  <thead>
    <tr>
      <th>Record ID</th>
      <th>UID</th>
      <th>Trolley Name</th>
      <th>Entry Date</th>
      <th>Entry Time</th>
      <th>Trolley Type</th>
      <th>TPM Category</th>
      <th>Previous TPM Completed</th>
      <th>Expiry TPM in Days</th>
      <th>Due Date</th>
      <th>Exit Date</th>
      <th>Exit Time</th>
      <th colspan="2">TPM Details</th>
      <th>Completed By User Name</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for record in records %}
    <tr>
      <td>{{ record.record_id }}</td>
      <td>{{ record.uid }}</td>
      <td>{{ record.trolley_name}}</td>
      <td>{{ record.entry_date }}</td>
      <td>{{ record.entry_time }}</td>
      <td>{{ record.trolley_category }}</td>
      <td>{{ record.remark }}</td>
      <td>{{ record.previous_completed_date }}</td>
      <td>{{ record.days_left }}</td>
      <td>{{ record.due_date }}</td>
      <td>{{ record.exit_date }}</td>
      <td>{{ record.exit_time }}</td>

      <td colspan="2">
        <table class="nest-table">
          <thead>
            <tr>
              <th>Check Point</th>
              <th>Concern</th>
              <th>Action Taken</th>
            </tr>
          </thead>
          <tbody>
            {% set points = (record.check_point or '').split(',') %}
            {% set concerns = (record.concern or '').split(',') %}
            {% set actions = (record.action_taken or '').split(',') %}
            {% for i in range(points|length) %}
            <tr class="{{ 'extra-row' if i >= 1 else '' }}" style="{{ 'display: none;' if i >= 1 else '' }}">
              <td>{{ points[i] if i < points|length else '' }}</td>
              <td>{{ concerns[i] if i < concerns|length else '' }}</td>
              <td>{{ actions[i] if i < actions|length else '' }}</td>
            </tr>
            {% endfor %}
            {% if points|length > 1 %}
            <tr>
              <td colspan="3">
                <button type="button" class="toggle-btn" onclick="toggleRows(this)">Show More</button>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </td>
      <td>{{ record.user_name }}</td>
      <td>
        {% if not record.exit_date %}
        <form action="/update_record/{{ record.record_id }}" method="get">
          <button type="submit" class="btn btn-outline-light text-dark">
            <i class="bi bi-pencil-square me-1"></i> Update
          </button>
        </form>
        {% else %}
        <span class="badge bg-success">Completed</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
<!-- END TABLE CONTAINER -->
</body>
</html>